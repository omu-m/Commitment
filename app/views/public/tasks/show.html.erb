<div class="container px-5 px-sm-0">
  <div class="row">
    <div class="col-md-2 offset-md-1 mt-4">
      <table class="table table-hover table-inverse" style="text-align:center;">
        <thead>
          <tr>
            <th>タスク詳細</th>
          </tr>
        </thead>
      </table>
    </div>
    <div class="col-md-10 offset-md-1">
      <table class="table table-hover table-inverse">
        <thead>
          <tr>
            <th>
              <% if @task.image.attached? %>
                <%= image_tag @task.image, size: "50x50", style: "border-radius: 50px;" %>
              <% else %>
                <%= image_tag "no_image.jpg", size: "50x50", style: "border-radius: 50px;" %>
              <% end %>
            </th>
            <th>
              <% unless current_member.email == "guest@example.com" %>
              <!--タスク(グループ)に参加しているとサブタスク一覧が表示されるようになる仕様。-->
              <a class="btn btn-outline-secondary" data-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                メンバー
              </a>
              <% end %>
              <% memberids = [] %>
              <% @task.members.each do |member| %>
              <div class="collapse" id="collapseExample">
                <div class="card card-body">
                  <% memberids.push(member.id) %>
                  <%= image_tag member.get_profile_image, size: "50x50", style: "border-radius: 50px;" %>
                  <%= member.display_name %>
                </div>
              </div>
              <% end %>
            </th>
            <th>
              <% if memberids.include?(current_member.id) %>
                <%= link_to "子タスク一覧", task_subtasks_path(@task), class: "btn btn-outline-secondary" %>
              <% end %>
            </th>
            <th class="text-danger font-weight-bold">
              達成率
              <% if @task.subtasks.size.zero? %>
                0 %
              <% else %>
                <%= ((@task.subtasks.where(progress_status: 3).size / @task.subtasks.size.to_f) * 100).round(2)%> %
              <% end %>
            </th>
            <% unless current_member.email == "guest@example.com" %>
              <th>

                申請ボタンは、以下の条件で表示させたい。
                  1. すでに加入している場合：退会するボタンが表示
                  2. まだ加入していない場合：申請ボタンが表示
                  3. すでに加入申請済の場合：申請取消ボタンを表示
                
                <% @task.task_members.find_by(member: current_member).approval_status == 0 %>
                  承認待ち

                <% @task.task_members.find_by(member: current_member).approval_status == 1 %>
                  退出

                <% @task.task_members.find_by(member: current_member).blank? || @task.task_members.find_by(member: current_member).approval_status == 2 %>
                  <%= link_to "参加申請", task_request_join_path(@task), class: "btn btn-outline-primary" %>


                  <%= link_to "申請を承認する", task_approval_request_path(@task), class: "btn btn-outline-primary" %>
                  <%= link_to "申請を否認する", task_non_approval_request_path(@task), class: "btn btn-outline-primary" %>

              <%# if @task.owner_id == current_member.id %>
                <%#= link_to "編集", edit_task_path(@task), class: "btn btn-outline-primary" %>
              <%# elsif @task.members.include?(current_member) %>
                <%#= link_to "退出", task_out_path(@task), method: :delete, class: "btn btn-outline-danger" %>
              <%# else %>
                <%#= link_to "参加申請", task_join_path(@task), class: "btn btn-outline-success" %>
              <%# end %>
              </th>
            <% end %>
          </tr>
        </thead>
      </table>
      <table class="my-4 mt-5", align="center" border="1" width="750" height="500">
        <tr>
          <th class="table-active text-center", width="20%" height="20%">タスク</th>
          <td class="text-center" style="word-break: break-all;"><%= @task.task_title %></td>
        </tr>
        <% if memberids.include?(current_member.id) %>
          <tr>
            <th class="table-active text-center", width="20%" height="80%">詳細</th>
            <td class="text-left", valign="top", style="display: block; overflow-y:scroll; height:430px; word-break: break-all;">
              <%= safe_join(@task.task_content.split("\n"),tag(:br)) %>
            </td>
          </tr>
        <% else %>
          <tr>
            <th class="table-active text-center", width="20%" height="80%">詳細</th>
            <td class="text-center">
              参加後、詳細が表示されます。
            </td>
          </tr>
        <% end %>
      </table>
    </div>
  </div>
</div>